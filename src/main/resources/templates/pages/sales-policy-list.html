<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="/assets/" data-template="vertical-menu-template-free" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>suaninc</title>
	<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
	<link rel="icon" href="/img/favicon.ico" type="image/x-icon">
	<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">

	<script src="/js/pages-script.js"></script>
	<link rel="stylesheet" href="/css/common.css" />
	<!-- Icons. Uncomment required icon fonts -->
	<link rel="stylesheet" href="/assets/vendor/fonts/boxicons.css" />
	<!-- Core CSS -->
	<link rel="stylesheet" href="/assets/vendor/css/core.css" class="template-customizer-core-css" />
	<link rel="stylesheet" href="/assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
	<link rel="stylesheet" href="/assets/css/demo.css" />
	<!-- Vendors CSS -->
	<link rel="stylesheet" href="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
	<link rel="stylesheet" href="/assets/vendor/libs/apex-charts/apex-charts.css" />
	<!-- Helpers -->
	<script src="/assets/vendor/js/helpers.js"></script>
	<script src="/assets/js/config.js"></script>
	<!-- AdressAPI -->
	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            
            <!-- Menu -->
            <div th:replace="~{/fragments/sidebar :: sidebar}"></div>
            <!-- / Menu -->

            <!-- Layout container -->
            <div class="layout-page">
                
                <!-- Content wrapper -->
                <div class="content-wrapper">
					
					<!-- Header -->
					<div class="row">
					    <div class="col-12">
					        <nav class="layout-navbar navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
					            <div class="navbar-nav align-items-center">
					                <i class="bx bx-cog me-2 text-primary fs-4"></i>
					                <span class="fw-semibold">판매정책 설정</span>
					            </div>
					            <div class="ms-auto">
					                <ol class="breadcrumb breadcrumb-style1 mb-0">
					                    <li class="breadcrumb-item">
					                        <a href="javascript:void(0);">설정</a>
					                    </li>
					                    <li class="breadcrumb-item">
					                        <a href="/homepage/template/templateList">판매정책 설정</a>
					                    </li>
					                    <li class="breadcrumb-item active">판매정책 목록</li>
					                </ol>
					            </div>
					        </nav>
					    </div>
					</div>
                    
                    <!-- Content -->
                    <div class="container-fluid flex-grow-1 container-p-y">
                        
                        <!-- Sales Policy List Card -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
							    <h5 class="card-title mb-0 d-flex align-items-center">
							        <i class="bx bx-list-ul me-2"></i>판매정책 목록
							    </h5>
                                
                                <!-- Excel Upload Form -->
                                <div class="d-flex align-items-center gap-2">
                                    <form id="excelUploadForm" method="post" enctype="multipart/form-data" action="/homepage/salesPolicy/uploadExcel" class="d-flex align-items-center gap-2">
                                        <div class="position-relative">
                                            <input type="file" name="file" class="form-control d-none" id="excelFile" accept=".xlsx,.xls" required>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('excelFile').click();">
                                                <i class="bx bx-upload me-1"></i>
                                                <span id="excelLabel">엑셀 선택</span>
                                            </button>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm" id="uploadBtn" disabled>
                                            <i class="bx bx-cloud-upload me-1"></i>업로드
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Upload Status -->
                            <div id="uploadStatus" class="alert alert-info border-info d-none mx-3 mt-3">
                                <div class="alert-body d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">업로드 중...</span>
                                    </div>
                                    엑셀 파일을 업로드하고 있습니다. 잠시만 기다려주세요...
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="table-responsive text-nowrap">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>판매정책명</th>
                                            <th class="text-center" style="width: 120px;">제품명</th>
                                            <th class="text-center" style="width: 120px;">요금제</th>
											<th class="text-center" style="width: 140px;">판매시작일시</th>
											<th class="text-center" style="width: 140px;">판매종료일시</th>
											<th class="text-center" style="width: 80px;">상태</th>
                                            <th class="text-center" style="width: 120px;">등록일자</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <th:block th:each="salesPolicy : ${salesPolicyList}">
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <i class="bx bx-bookmark text-primary me-2"></i>
                                                        <a th:href="@{/homepage/salesPolicy/salesPolicyInfo(id=${salesPolicy.id})}" 
                                                           class="fw-medium text-primary text-decoration-none hover-underline"
                                                           th:text="${salesPolicy.salesPolicyName}">
                                                        </a>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-label-info" th:text="${salesPolicy.productName}"></span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-label-primary" th:text="${salesPolicy.planName}"></span>
                                                </td>
												<td class="text-center">
													<small class="text-muted" th:text="${#temporals.format(salesPolicy.startDatetime, 'yyyy-MM-dd HH:mm')}"></small>
												</td>
												<td class="text-center">
												    <small class="text-muted" th:text="${#temporals.format(salesPolicy.endDatetime, 'yyyy-MM-dd HH:mm')}"></small>
												</td>
												<td class="text-center">
												    <!-- 종료 -->
												    <span th:if="${salesPolicy.endDatetime != null and salesPolicy.endDatetime.isBefore(T(java.time.LocalDateTime).now())}" class="badge bg-secondary">종료</span>
												    <!-- 대기 -->
												    <span th:if="${salesPolicy.startDatetime != null and salesPolicy.startDatetime.isAfter(T(java.time.LocalDateTime).now())}" class="badge bg-warning">대기</span>
												    <!-- 진행중 -->
												    <span th:if="${salesPolicy.startDatetime != null and salesPolicy.endDatetime != null and ((salesPolicy.startDatetime.isBefore(T(java.time.LocalDateTime).now()) or salesPolicy.startDatetime.isEqual(T(java.time.LocalDateTime).now())) and (salesPolicy.endDatetime.isAfter(T(java.time.LocalDateTime).now()) or salesPolicy.endDatetime.isEqual(T(java.time.LocalDateTime).now())))}" class="badge bg-success">진행중</span>
												</td>
												<td class="text-center">
												    <small class="text-muted" th:text="${#temporals.format(salesPolicy.lastUpdatedDatetime, 'yyyy-MM-dd HH:mm')}"></small>
												</td>
                                            </tr>
                                        </th:block>
                                        <tr th:if="${#lists.isEmpty(salesPolicyList)}">
                                            <td class="text-center text-muted" colspan="7">
                                                <div class="py-4">
                                                    <i class="bx bx-mobile-alt fs-2 mb-2 d-block text-muted"></i>
                                                    등록된 판매정책이 없습니다.
                                                    <br>
                                                    <small>엑셀 파일을 업로드하여 판매정책을 등록하세요.</small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <div class="card-footer">
                                <div class="row align-items-center">
									<!-- 좌측 정보 표시 -->
									<div class="col-md-6">
									    <div class="text-muted">
									        <small>
									            총 <span class="fw-medium" th:text="${salesPolicyList.totalElements}"></span>개 항목 중 
									            <span class="fw-medium" th:text="${salesPolicyList.number * salesPolicyList.size + 1}"></span>-<span class="fw-medium" th:text="${(salesPolicyList.number + 1) * salesPolicyList.size > salesPolicyList.totalElements ? salesPolicyList.totalElements : (salesPolicyList.number + 1) * salesPolicyList.size}"></span>개 표시
									        </small>
									    </div>
									</div>
									
                                    <div class="col-md-6">
                                        <nav aria-label="Page navigation">
                                            <ul class="pagination pagination-sm justify-content-end mb-0">
                                                <li class="page-item" th:classappend="${salesPolicyList.number == 0} ? 'disabled'">
                                                    <a th:href="@{/homepage/salesPolicy/salesPolicyList(page=${0})}" class="page-link">
                                                        <i class="bx bx-chevrons-left" style="font-size: 0.6rem;"></i>
                                                    </a>
                                                </li>
                                                
                                                <li class="page-item" th:classappend="${salesPolicyList.number == 0} ? 'disabled'">
                                                    <a th:href="@{/homepage/salesPolicy/salesPolicyList(page=${salesPolicyList.number - 1})}" class="page-link">
                                                        <i class="bx bx-chevron-left" style="font-size: 0.6rem;"></i>
                                                    </a>
                                                </li>

                                                <!-- 페이지 번호 출력 -->
                                                <li th:each="i : ${#numbers.sequence(
                                                        salesPolicyList.number < 3 ? 0 : (salesPolicyList.number >= salesPolicyList.totalPages - 3 ? salesPolicyList.totalPages - 5 : salesPolicyList.number - 2),
                                                        salesPolicyList.number < 3 ? (salesPolicyList.totalPages >= 5 ? 4 : salesPolicyList.totalPages - 1) : (salesPolicyList.number >= salesPolicyList.totalPages - 3 ? salesPolicyList.totalPages - 1 : salesPolicyList.number + 2))}"
                                                    class="page-item" th:classappend="${salesPolicyList.number == i} ? 'active'">
                                                    <a th:href="@{/homepage/salesPolicy/salesPolicyList(page=${i})}" class="page-link" th:text="${i + 1}"></a>
                                                </li>

                                                <li class="page-item" th:classappend="${salesPolicyList.number == salesPolicyList.totalPages - 1} ? 'disabled'">
                                                    <a th:if="${salesPolicyList.number < salesPolicyList.totalPages - 1}" 
                                                       th:href="@{/homepage/salesPolicy/salesPolicyList(page=${salesPolicyList.number + 1})}" 
                                                       class="page-link">
                                                        <i class="bx bx-chevron-right" style="font-size: 0.6rem;"></i>
                                                    </a>
                                                    <span th:if="${salesPolicyList.number == salesPolicyList.totalPages - 1}" class="page-link">
                                                        <i class="bx bx-chevron-right" style="font-size: 0.6rem;"></i>
                                                    </span>
                                                </li>

                                                <li class="page-item" th:classappend="${salesPolicyList.number == salesPolicyList.totalPages - 1} ? 'disabled'">
                                                    <a th:if="${salesPolicyList.number < salesPolicyList.totalPages - 1}" 
                                                       th:href="@{/homepage/salesPolicy/salesPolicyList(page=${salesPolicyList.totalPages - 1})}" 
                                                       class="page-link">
                                                        <i class="bx bx-chevrons-right" style="font-size: 0.6rem;"></i>
                                                    </a>
                                                    <span th:if="${salesPolicyList.number == salesPolicyList.totalPages - 1}" class="page-link">
                                                        <i class="bx bx-chevrons-right" style="font-size: 0.6rem;"></i>
                                                    </span>
                                                </li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- / Content -->

                    <!-- Footer -->
                    <div th:replace="~{/fragments/footer :: footer}"></div>
                    <!-- / Footer -->

                    <div class="content-backdrop fade"></div>
                </div>
                <!-- Content wrapper -->
            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Core JS -->
    <script src="/assets/vendor/libs/jquery/jquery.js"></script>
    <script src="/assets/vendor/libs/popper/popper.js"></script>
    <script src="/assets/vendor/js/bootstrap.js"></script>
    <script src="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="/assets/vendor/js/menu.js"></script>

    <!-- Vendors JS -->
    <script src="/assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js"></script>

    <!-- Main JS -->
    <script src="/assets/js/main.js"></script>

    <!-- Page JS -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const fileInput = document.getElementById("excelFile");
            const label = document.getElementById("excelLabel");
            const uploadBtn = document.getElementById("uploadBtn");
            const form = document.getElementById("excelUploadForm");
            const uploadStatus = document.getElementById("uploadStatus");
            
            // 파일 선택 시 처리
            fileInput.addEventListener("change", function (e) {
                const file = e.target.files[0];
                if (file) {
                    const fileName = file.name;
                    const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                    label.innerHTML = `<i class="bx bx-file me-1"></i>${fileName} (${fileSize}MB)`;
                    uploadBtn.disabled = false;
                    uploadBtn.classList.remove('btn-outline-secondary');
                    uploadBtn.classList.add('btn-primary');
                    
                    // 파일 유효성 검사
                    if (!fileName.match(/\.(xlsx|xls)$/i)) {
                        showAlert('엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.', 'danger');
                        resetFileInput();
                        return;
                    }
                    
                    if (file.size > 10 * 1024 * 1024) { // 10MB 제한
                        showAlert('파일 크기는 10MB 이하만 업로드 가능합니다.', 'danger');
                        resetFileInput();
                        return;
                    }
                } else {
                    resetFileInput();
                }
            });
            
            // 폼 제출 시 처리
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                
                if (!fileInput.files[0]) {
                    showAlert('업로드할 파일을 선택해주세요.', 'warning');
                    return;
                }
                
                // 업로드 상태 표시
                uploadStatus.classList.remove('d-none');
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>업로드중...';
                
                // FormData 생성 및 전송
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    uploadStatus.classList.add('d-none');
                    if (data.success) {
                        showAlert(`${data.message} 페이지를 새로고침합니다.`, 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showAlert('업로드 중 오류가 발생했습니다: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    uploadStatus.classList.add('d-none');
                    showAlert('업로드 중 오류가 발생했습니다.', 'danger');
                    console.error('Upload error:', error);
                })
                .finally(() => {
                    resetFileInput();
                });
            });
            
            function resetFileInput() {
                fileInput.value = '';
                label.innerHTML = '<i class="bx bx-upload me-1"></i>엑셀 선택';
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="bx bx-cloud-upload me-1"></i>업로드';
                uploadBtn.classList.remove('btn-primary');
                uploadBtn.classList.add('btn-outline-secondary');
            }
            
            function showAlert(message, type) {
                // 기존 알림 제거
                const existingAlert = document.querySelector('.custom-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // 새 알림 생성
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible custom-alert`;
                alert.innerHTML = `
                    <div class="alert-body">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // 카드 헤더 다음에 삽입
                const cardHeader = document.querySelector('.card-header');
                cardHeader.insertAdjacentElement('afterend', alert);
                
                // 3초 후 자동 제거
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 3000);
            }
            
            // 호버 효과를 위한 CSS 추가
            const style = document.createElement('style');
            style.textContent = `
                .hover-underline:hover {
                    text-decoration: underline !important;
                }
                
                .table tbody tr:hover {
                    background-color: rgba(67, 89, 113, 0.04);
                }
                
                .custom-alert {
                    margin: 0 1rem;
                    margin-bottom: 1rem;
                    border-radius: 0.375rem;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
	
	<div th:replace="~{fragments/password-check-modal :: passwordCheckModal}"></div>
	
</body>
</html>